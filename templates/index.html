<script>
    const logEl = document.getElementById('log');
    const select = document.getElementById('app-select');
    const ansi_up = new AnsiUp();
    ansi_up.use_classes = false;
  
    let ws;
  
    fetch('/pm2-logs/apps')
      .then(res => res.json())
      .then(apps => {
        apps.forEach(app => {
          const opt = document.createElement('option');
          opt.value = app;
          opt.textContent = app;
          select.appendChild(opt);
        });
        if (apps.length > 0) {
          connectWebSocket(apps[0]);
        }
      });
  
    function connectWebSocket(appName) {
      if (ws) ws.close();
  
      const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
      ws = new WebSocket(protocol + window.location.host + '/pm2-logs/logs');
  
      ws.onopen = () => {
        ws.send(appName);
      };
  
      ws.onmessage = (e) => {
        const isAtBottom = logEl.scrollHeight - logEl.scrollTop <= logEl.clientHeight + 20;
  
        const html = ansi_up.ansi_to_html(e.data);
        const div = document.createElement('div');
        div.innerHTML = html;
        logEl.appendChild(div);
  
        if (isAtBottom) {
            logEl.scrollTop = logEl.scrollHeight;
        }
      };
  
      ws.onclose = () => {
        setTimeout(() => connectWebSocket(select.value), 2000);
      };
    }
  
    select.addEventListener('change', () => {
      logEl.innerHTML = '';
      connectWebSocket(select.value);
    });
  </script>
  